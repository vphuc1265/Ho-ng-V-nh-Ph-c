name: üîë Generate Secure Daily Key

on:
  schedule:
    - cron: '0 17 * * *'  # 00:00 VN - SANG NG√ÄY M·ªöI
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  generate-key:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Generate Secure Daily Data
      run: |
        # T·∫°o key cho NG√ÄY H√îM NAY (v√¨ ch·∫°y l√∫c 00:00 VN)
        TODAY=$(date +%Y%m%d)
        KEY="vphuc_${TODAY}_$(openssl rand -hex 6 | tr '[:lower:]' '[:upper:]')"
        
        # R√∫t g·ªçn link v∆∞·ª£t (CH·ªà 1 L·∫¶N/NG√ÄY)
        GITHUB_PAGES_URL="https://dailykey-hvp.github.io/"
        RESPONSE=$(curl -s "https://link4m.co/api-shorten/v2?api=68db842cd32fc747763d594d&url=${GITHUB_PAGES_URL}")
        SHORT_URL=$(echo "$RESPONSE" | grep -o '"shortenedUrl":"[^"]*' | cut -d'"' -f4 || echo "$GITHUB_PAGES_URL")
        
        # L∆∞u config
        echo "{\"key\":\"$KEY\",\"date\":\"$TODAY\",\"short_url\":\"$SHORT_URL\"}" > daily-key.json
        
        # T·∫°o HTML redirect cho GitHub Pages
        mkdir -p docs
        cat > docs/index.html << EOF
        <!DOCTYPE html>
        <html>
        <head>
            <title>SECURITY KEY - $TODAY</title>
            <style>
                body { background: #0a0a15; color: #00ffea; font-family: Arial; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
                .container { text-align: center; }
                .key { font-size: 1.5rem; margin: 20px 0; padding: 15px; border: 2px solid #00ffea; border-radius: 10px; }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>DAILY SECURITY KEY</h1>
                <div class="key">$KEY</div>
                <p>Copy key n√†y v√† d√°n v√†o tool</p>
                <p>‚è∞ Key h·∫øt h·∫°n l√∫c 23:59 ng√†y $TODAY</p>
            </div>
        </body>
        </html>
        EOF
        
        git config user.name "github-actions"
        git config user.email "actions@github.com"
        git add daily-key.json docs/
        git commit -m "Auto: Daily key for $TODAY"
        git push

    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs
