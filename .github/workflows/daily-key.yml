name: 🔑 Generate Secure Daily Key

on:
  schedule:
    - cron: '0 17 * * *'  # 00:00 VN - SANG NGÀY MỚI
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-key:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Generate Secure Daily Data
      run: |
        # Tạo key cho NGÀY HÔM NAY
        TODAY=$(date +%Y%m%d)
        KEY="vphuc_${TODAY}_$(openssl rand -hex 6 | tr '[:lower:]' '[:upper:]')"
        
        # Tạo HTML content với key
        HTML_CONTENT="<!DOCTYPE html><html><head><title>Key</title></head><body><h1>KEY: $KEY</h1><script>navigator.clipboard.writeText('$KEY');alert('Key copied: $KEY');</script></body></html>"
        
        # Encode HTML thành base64
        ENCODED_HTML=$(echo "$HTML_CONTENT" | base64 -w 0)
        
        # Tạo data URL (ẩn hoàn toàn domain)
        DATA_URL="data:text/html;base64,$ENCODED_HTML"
        
        # Rút gọn data URL
        RESPONSE=$(curl -s "https://link4m.co/api-shorten/v2?api=68db842cd32fc747763d594d&url=$(echo "$DATA_URL" | sed 's/+/%2B/g')")
        SHORT_URL=$(echo "$RESPONSE" | grep -o '"shortenedUrl":"[^"]*' | cut -d'"' -f4)
        
        if [ -z "$SHORT_URL" ]; then
            # Fallback: dùng direct data URL
            SHORT_URL="$DATA_URL"
        fi
        
        # Lưu config
        echo "{\"key\":\"$KEY\",\"date\":\"$TODAY\",\"short_url\":\"$SHORT_URL\"}" > daily-key.json
        
        git config user.name "github-actions"
        git config user.email "actions@github.com"
        git add daily-key.json
        git commit -m "Auto: Daily key for $TODAY"
        git push
