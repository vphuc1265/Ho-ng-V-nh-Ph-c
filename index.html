<script>
    // === SIMPLE WORKING VERSION ===
    async function getDailyKey() {
        try {
            // T·∫°o fingerprint ƒë∆°n gi·∫£n
            const fingerprint = btoa(navigator.userAgent + screen.width + screen.height);
            
            const response = await fetch('https://vphuc-key-server.hoangvinhphucbro.workers.dev', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'User-Agent': 'Mozilla/5.0 vphuc-tool',
                    'X-Client-Fingerprint': fingerprint,
                    'X-Timestamp': Date.now().toString(),
                    'X-Nonce': 'test123',
                    'X-Signature': 'temp_signature',
                    'X-Session-Token': 'temp_token'
                },
                body: JSON.stringify({ action: 'get_key' })
            });
            
            const result = await response.json();
            
            if (result.success && result.data) {
                // Gi·∫£i m√£ ƒë∆°n gi·∫£n
                const decryptedData = atob(result.data);
                const keyData = JSON.parse(decryptedData);
                showValidKey(keyData.key, keyData.expires);
            } else {
                // Fallback: t·∫°o key client-side
                createFallbackKey();
            }
        } catch (error) {
            // Fallback: t·∫°o key client-side
            createFallbackKey();
        }
    }

    function createFallbackKey() {
        const today = new Date();
        const dateStr = today.getFullYear() + 
                       String(today.getMonth() + 1).padStart(2, '0') + 
                       String(today.getDate()).padStart(2, '0');
        
        const random = Math.random().toString(36).substring(2, 10).toUpperCase();
        const key = "vphuc_" + dateStr + random;
        
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        const expires = tomorrow.toLocaleDateString('vi-VN');
        
        showValidKey(key, expires);
    }

    function showValidKey(key, expires) {
        document.getElementById('content').innerHTML = `
            <div class="key-section">
                <div class="key-label">üîë Key Tool Ng√†y H√¥m Nay:</div>
                <div class="key-value">${key}</div>
                <button class="copy-btn" onclick="copyKey('${key}')">üìã Copy Key</button>
            </div>
            <div class="expiry">
                ‚è∞ Key c√≥ hi·ªáu l·ª±c ƒë·∫øn: ${expires} 00:00
            </div>
        `;
    }

    function showAccessError() {
        document.getElementById('content').innerHTML = `
            <div class="no-key">
                <h3>üîë Key Ch·ªâ Hi·ªán Th·ªã 1 L·∫ßn Duy Nh·∫•t Sau Khi V∆∞·ª£t Link</h3>
                <p>Vui L√≤ng V∆∞·ª£t Link Trong Tool ƒê·ªÉ L·∫•y Key !</p>
            </div>
        `;
    }

    function copyKey(key) {
        navigator.clipboard.writeText(key).then(() => {
            alert('ƒê√£ Copy Key V√†o Clipboard !');
        });
    }

    // === X·ª¨ L√ù URL ===
    const urlParams = new URLSearchParams(window.location.search);
    const keyParam = urlParams.get('key');

    if (keyParam === 'GET_DAILY_KEY') {
        getDailyKey();
        
        // X√≥a parameter sau 2 gi√¢y
        setTimeout(() => {
            window.history.replaceState({}, '', window.location.pathname);
        }, 2000);
    } else {
        showAccessError();
    }
</script>
